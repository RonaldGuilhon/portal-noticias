<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Cache - Portal de Notícias</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../assets/css/admin.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboard.html">
                                <i class="bi bi-house"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="noticias.html">
                                <i class="bi bi-newspaper"></i> Notícias
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="comentarios.html">
                                <i class="bi bi-chat-dots"></i> Comentários
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="usuarios.html">
                                <i class="bi bi-people"></i> Usuários
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="categorias.html">
                                <i class="bi bi-tags"></i> Categorias
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="tags.html">
                                <i class="bi bi-bookmark"></i> Tags
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="newsletter.html">
                                <i class="bi bi-envelope"></i> Newsletter
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="anuncios.html">
                                <i class="bi bi-megaphone"></i> Anúncios
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="backup.html">
                                <i class="bi bi-shield-check"></i> Backup
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="cache.html">
                                <i class="bi bi-lightning"></i> Cache
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="configuracoes.html">
                                <i class="bi bi-gear"></i> Configurações
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">Gerenciamento de Cache</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshStats()">
                                <i class="bi bi-arrow-clockwise"></i> Atualizar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Status do Cache -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Status do Cache</h5>
                                <span id="cache-status-badge" class="badge bg-secondary">Carregando...</span>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Status:</strong> <span id="cache-enabled">-</span></p>
                                        <p><strong>Tipo:</strong> <span id="cache-type">-</span></p>
                                        <p><strong>TTL Padrão:</strong> <span id="cache-ttl">-</span> segundos</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Caminho:</strong> <span id="cache-path">-</span></p>
                                        <div class="mt-3">
                                            <button id="toggle-cache-btn" class="btn btn-primary me-2" onclick="toggleCache()">-</button>
                                            <button class="btn btn-warning me-2" onclick="clearExpiredCache()">
                                                <i class="bi bi-trash"></i> Limpar Expirados
                                            </button>
                                            <button class="btn btn-danger" onclick="clearAllCache()">
                                                <i class="bi bi-trash-fill"></i> Limpar Tudo
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estatísticas do Cache -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Total de Arquivos</h5>
                                <h2 class="text-primary" id="total-files">-</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Tamanho Total</h5>
                                <h2 class="text-info" id="total-size">-</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Arquivos Expirados</h5>
                                <h2 class="text-warning" id="expired-files">-</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">Taxa de Hit</h5>
                                <h2 class="text-success" id="hit-rate">-</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Log de Atividades -->
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Log de Atividades</h5>
                            </div>
                            <div class="card-body">
                                <div id="cache-log" class="bg-light p-3" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em;">
                                    <div class="text-muted">Carregando log...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal de Confirmação -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Ação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirm-message">
                    <!-- Mensagem será inserida aqui -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirm-action" onclick="executeConfirmedAction()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
        let currentAction = null;
        let confirmModal = null;

        // Inicializar página
        document.addEventListener('DOMContentLoaded', function() {
            confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            loadCacheStatus();
            loadCacheStats();
            startAutoRefresh();
        });

        // Carregar status do cache
        async function loadCacheStatus() {
            try {
                const response = await fetch('http://localhost:8001/cache/stats');
                const data = await response.json();
                
                if (data.sucesso) {
                    const enabled = data.enabled;
                    document.getElementById('cache-enabled').textContent = enabled ? 'Habilitado' : 'Desabilitado';
                    document.getElementById('cache-type').textContent = data.config.type;
                    document.getElementById('cache-ttl').textContent = data.config.ttl;
                    document.getElementById('cache-path').textContent = data.config.path;
                    
                    const statusBadge = document.getElementById('cache-status-badge');
                    const toggleBtn = document.getElementById('toggle-cache-btn');
                    
                    if (enabled) {
                        statusBadge.className = 'badge bg-success';
                        statusBadge.textContent = 'Ativo';
                        toggleBtn.className = 'btn btn-warning me-2';
                        toggleBtn.innerHTML = '<i class="bi bi-pause"></i> Desabilitar';
                    } else {
                        statusBadge.className = 'badge bg-danger';
                        statusBadge.textContent = 'Inativo';
                        toggleBtn.className = 'btn btn-success me-2';
                        toggleBtn.innerHTML = '<i class="bi bi-play"></i> Habilitar';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar status do cache:', error);
                showNotification('Erro ao carregar status do cache', 'error');
            }
        }

        // Carregar estatísticas do cache
        async function loadCacheStats() {
            try {
                const response = await fetch('http://localhost:8001/cache/stats');
                const data = await response.json();
                
                if (data.sucesso) {
                    const stats = data.stats;
                    document.getElementById('total-files').textContent = stats.total_files;
                    document.getElementById('total-size').textContent = stats.total_size_formatted;
                    document.getElementById('expired-files').textContent = stats.expired_files;
                    
                    // Calcular taxa de hit (simulada)
                    const hitRate = stats.total_files > 0 ? Math.round((stats.total_files - stats.expired_files) / stats.total_files * 100) : 0;
                    document.getElementById('hit-rate').textContent = hitRate + '%';
                }
            } catch (error) {
                console.error('Erro ao carregar estatísticas do cache:', error);
                showNotification('Erro ao carregar estatísticas do cache', 'error');
            }
        }

        // Alternar status do cache
        function toggleCache() {
            const statusElement = document.getElementById('cache-enabled');
            const isEnabled = statusElement.textContent === 'Habilitado';
            const action = isEnabled ? 'disable' : 'enable';
            const actionText = isEnabled ? 'desabilitar' : 'habilitar';
            
            showConfirmModal(
                `Tem certeza que deseja ${actionText} o cache?`,
                () => executeCacheAction(action)
            );
        }

        // Limpar cache expirado
        function clearExpiredCache() {
            showConfirmModal(
                'Tem certeza que deseja limpar apenas os arquivos de cache expirados?',
                () => executeCacheAction('clear-expired')
            );
        }

        // Limpar todo o cache
        function clearAllCache() {
            showConfirmModal(
                'Tem certeza que deseja limpar TODOS os arquivos de cache? Esta ação não pode ser desfeita.',
                () => executeCacheAction('clear', 'DELETE')
            );
        }

        // Executar ação do cache
        async function executeCacheAction(action, method = 'POST') {
            try {
                const response = await fetch(`http://localhost:8001/cache/${action}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const data = await response.json();
                
                if (data.sucesso) {
                    showNotification(data.mensagem, 'success');
                    loadCacheStatus();
                    loadCacheStats();
                    addLogEntry(data.mensagem);
                } else {
                    showNotification(data.erro || 'Erro ao executar ação', 'error');
                }
            } catch (error) {
                console.error('Erro ao executar ação do cache:', error);
                showNotification('Erro ao executar ação do cache', 'error');
            }
        }

        // Atualizar estatísticas
        function refreshStats() {
            loadCacheStatus();
            loadCacheStats();
            showNotification('Estatísticas atualizadas', 'success');
        }

        // Mostrar modal de confirmação
        function showConfirmModal(message, callback) {
            document.getElementById('confirm-message').textContent = message;
            currentAction = callback;
            confirmModal.show();
        }

        // Executar ação confirmada
        function executeConfirmedAction() {
            if (currentAction) {
                currentAction();
                currentAction = null;
            }
            confirmModal.hide();
        }

        // Adicionar entrada ao log
        function addLogEntry(message) {
            const logElement = document.getElementById('cache-log');
            const timestamp = new Date().toLocaleString('pt-BR');
            const entry = `[${timestamp}] ${message}\n`;
            
            if (logElement.textContent === 'Carregando log...') {
                logElement.textContent = entry;
            } else {
                logElement.textContent = entry + logElement.textContent;
            }
            
            // Manter apenas as últimas 50 entradas
            const lines = logElement.textContent.split('\n');
            if (lines.length > 50) {
                logElement.textContent = lines.slice(0, 50).join('\n');
            }
        }

        // Auto-refresh das estatísticas
        function startAutoRefresh() {
            setInterval(() => {
                loadCacheStats();
            }, 30000); // Atualizar a cada 30 segundos
        }

        // Mostrar notificação
        function showNotification(message, type = 'info') {
            // Implementar sistema de notificações
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 'alert-info';
            
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alert);
            
            // Remover automaticamente após 5 segundos
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }
    </script>
</body>
</html>