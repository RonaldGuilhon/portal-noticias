<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usuários - Portal de Notícias Admin</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link href="../assets/css/style.css" rel="stylesheet">
    <link href="assets/css/admin.css" rel="stylesheet">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
    </div>
    
    <!-- Header -->
    <header class="admin-header">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <button id="sidebar-toggle" class="btn btn-link text-dark p-0 me-3">
                    <i class="fas fa-bars fs-5"></i>
                </button>
                <h1 class="h4 mb-0">Usuários</h1>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <!-- Notifications -->
                <div class="dropdown">
                    <button class="btn btn-link text-dark p-0 position-relative" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-bell fs-5"></i>
                        <span id="notification-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">0</span>
                    </button>
                    <ul id="notifications-list" class="dropdown-menu dropdown-menu-end" style="min-width: 300px;">
                        <li><span class="dropdown-item-text text-muted">Carregando...</span></li>
                    </ul>
                </div>
                
                <!-- User Menu -->
                <div class="dropdown">
                    <button class="btn btn-link text-dark p-0 d-flex align-items-center" type="button" data-bs-toggle="dropdown">
                        <img id="admin-avatar" src="../assets/images/default-avatar.svg" alt="Admin" class="rounded-circle me-2" width="32" height="32">
                        <span id="admin-name">Admin</span>
                        <i class="fas fa-chevron-down ms-2 small"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="../perfil.html"><i class="fas fa-user me-2"></i>Perfil</a></li>
                        <li><a class="dropdown-item" href="configuracoes.html"><i class="fas fa-cog me-2"></i>Configurações</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </header>
    
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside id="admin-sidebar" class="admin-sidebar">
            <div class="sidebar-brand">
                <i class="fas fa-newspaper text-primary"></i>
                <span class="brand-text">Portal Admin</span>
            </div>
            
            <nav class="sidebar-nav">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="noticias.html">
                            <i class="fas fa-newspaper"></i>
                            <span>Notícias</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="categorias.html">
                            <i class="fas fa-folder"></i>
                            <span>Categorias</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="tags.html">
                            <i class="fas fa-tags"></i>
                            <span>Tags</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="comentarios.html">
                            <i class="fas fa-comments"></i>
                            <span>Comentários</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="newsletter.html">
                            <i class="fas fa-envelope"></i>
                            <span>Newsletter</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="usuarios.html">
                            <i class="fas fa-users"></i>
                            <span>Usuários</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="autores.html">
                            <i class="fas fa-user-edit"></i>
                            <span>Autores</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="uploads.html">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Uploads</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="anuncios.html">
                            <i class="fas fa-ad"></i>
                            <span>Anúncios</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="estatisticas.html">
                            <i class="fas fa-chart-bar"></i>
                            <span>Estatísticas</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="configuracoes.html">
                            <i class="fas fa-cog"></i>
                            <span>Configurações</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="logs.html">
                            <i class="fas fa-file-alt"></i>
                            <span>Logs</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="admin-main">
            <div class="container-fluid">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="page-title">Usuários</h2>
                            <p class="page-subtitle">Gerencie usuários registrados no sistema</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="exportUsers()">
                                <i class="fas fa-download me-2"></i>Exportar
                            </button>
                            <button class="btn btn-outline-secondary" onclick="showBulkActions()">
                                <i class="fas fa-tasks me-2"></i>Ações em Lote
                            </button>
                            <button class="btn btn-primary" onclick="showUserModal()">
                                <i class="fas fa-plus me-2"></i>Novo Usuário
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-icon bg-primary">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stats-content">
                                <h3 id="total-users">0</h3>
                                <p>Total de Usuários</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-icon bg-success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stats-content">
                                <h3 id="active-users">0</h3>
                                <p>Usuários Ativos</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-icon bg-info">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="stats-content">
                                <h3 id="new-users">0</h3>
                                <p>Novos (30 dias)</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <div class="stats-icon bg-warning">
                                <i class="fas fa-user-clock"></i>
                            </div>
                            <div class="stats-content">
                                <h3 id="pending-users">0</h3>
                                <p>Pendentes</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label">Buscar</label>
                                <div class="input-group">
                                    <input type="text" id="search-users" class="form-control" placeholder="Nome, email ou ID...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="searchUsers()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Status</label>
                                <select id="status-filter" class="form-select" onchange="filterUsers()">
                                    <option value="">Todos</option>
                                    <option value="ativo">Ativo</option>
                                    <option value="inativo">Inativo</option>
                                    <option value="suspenso">Suspenso</option>
                                    <option value="pendente">Pendente</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Tipo</label>
                                <select id="type-filter" class="form-select" onchange="filterUsers()">
                                    <option value="">Todos</option>
                                    <option value="admin">Admin</option>
                                    <option value="autor">Autor</option>
                                    <option value="usuario">Usuário</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Período</label>
                                <select id="period-filter" class="form-select" onchange="filterUsers()">
                                    <option value="">Todos</option>
                                    <option value="today">Hoje</option>
                                    <option value="week">Esta semana</option>
                                    <option value="month">Este mês</option>
                                    <option value="year">Este ano</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Ordenar por</label>
                                <select id="sort-users" class="form-select" onchange="sortUsers()">
                                    <option value="data_cadastro-desc">Mais recentes</option>
                                    <option value="data_cadastro-asc">Mais antigos</option>
                                    <option value="nome-asc">Nome A-Z</option>
                                    <option value="nome-desc">Nome Z-A</option>
                                    <option value="email-asc">Email A-Z</option>
                                    <option value="ultimo_acesso-desc">Último acesso</option>
                                </select>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-outline-secondary d-block w-100" onclick="clearFilters()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- View Mode Toggle -->
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="view-mode" id="list-view" checked>
                        <label class="btn btn-outline-secondary" for="list-view" onclick="setViewMode('list')">
                            <i class="fas fa-list"></i> Lista
                        </label>
                        
                        <input type="radio" class="btn-check" name="view-mode" id="grid-view">
                        <label class="btn btn-outline-secondary" for="grid-view" onclick="setViewMode('grid')">
                            <i class="fas fa-th"></i> Grade
                        </label>
                    </div>
                    
                    <span id="users-count" class="text-muted">0 usuários encontrados</span>
                </div>
                
                <!-- Users List -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <input type="checkbox" class="form-check-input me-3" onchange="toggleAllUsers(this)">
                            <span>Selecionar todos</span>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success" onclick="bulkActivate()">
                                <i class="fas fa-check me-1"></i>Ativar
                            </button>
                            <button class="btn btn-outline-warning" onclick="bulkSuspend()">
                                <i class="fas fa-pause me-1"></i>Suspender
                            </button>
                            <button class="btn btn-outline-danger" onclick="bulkDelete()">
                                <i class="fas fa-trash me-1"></i>Excluir
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div id="users-list">
                            <!-- Users will be loaded here -->
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <select id="per-page" class="form-select form-select-sm" style="width: auto;" onchange="changePerPage()">
                                    <option value="25">25 por página</option>
                                    <option value="50" selected>50 por página</option>
                                    <option value="100">100 por página</option>
                                </select>
                            </div>
                            <nav id="users-pagination">
                                <!-- Pagination will be loaded here -->
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">Novo Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="userForm">
                    <div class="modal-body">
                        <input type="hidden" id="user-id">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Nome Completo *</label>
                                    <input type="text" class="form-control" id="user-name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Email *</label>
                                    <input type="email" class="form-control" id="user-email" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Senha</label>
                                    <input type="password" class="form-control" id="user-password">
                                    <small class="form-text text-muted">Deixe em branco para manter a senha atual</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Confirmar Senha</label>
                                    <input type="password" class="form-control" id="user-password-confirm">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Tipo de Usuário</label>
                                    <select class="form-select" id="user-type">
                                        <option value="usuario">Usuário</option>
                                        <option value="autor">Autor</option>
                                        <option value="admin">Administrador</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="user-status">
                                        <option value="ativo">Ativo</option>
                                        <option value="inativo">Inativo</option>
                                        <option value="suspenso">Suspenso</option>
                                        <option value="pendente">Pendente</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Biografia</label>
                            <textarea class="form-control" id="user-bio" rows="3" placeholder="Biografia do usuário..."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Telefone</label>
                                    <input type="tel" class="form-control" id="user-phone">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Data de Nascimento</label>
                                    <input type="date" class="form-control" id="user-birthdate">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Foto do Perfil</label>
                            <input type="file" class="form-control" id="user-avatar" accept="image/*">
                            <div id="avatar-preview" class="mt-2" style="display: none;">
                                <img id="avatar-img" src="" alt="Preview" class="rounded-circle" width="80" height="80">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="user-newsletter">
                                <label class="form-check-label" for="user-newsletter">
                                    Inscrito na newsletter
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="user-verified">
                                <label class="form-check-label" for="user-verified">
                                    Email verificado
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Usuário</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- User Details Modal -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes do Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="user-details-content">
                    <!-- User details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" onclick="editUserFromDetails()">Editar Usuário</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="../assets/js/main.js"></script>
    <script src="assets/js/admin.js"></script>
    
    <script>
        let currentPage = 1;
        let perPage = 50;
        let totalPages = 1;
        let currentFilters = {};
        let currentSort = 'data_cadastro-desc';
        let viewMode = 'list';
        let currentUserId = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadUsers();
            setupEventListeners();
        });
        
        async function loadStats() {
            try {
                const result = await adminPanel.apiGet('admin/usuarios/stats');
                if (result.success) {
                    document.getElementById('total-users').textContent = result.data.total_usuarios || 0;
                    document.getElementById('active-users').textContent = result.data.usuarios_ativos || 0;
                    document.getElementById('new-users').textContent = result.data.novos_usuarios || 0;
                    document.getElementById('pending-users').textContent = result.data.usuarios_pendentes || 0;
                }
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }
        
        async function loadUsers() {
            try {
                adminPanel.showLoading(true);
                
                const params = new URLSearchParams({
                    page: currentPage,
                    per_page: perPage,
                    sort: currentSort,
                    ...currentFilters
                });
                
                const result = await adminPanel.apiGet(`admin/usuarios?${params}`);
                
                if (result.success) {
                    displayUsers(result.data.items);
                    updatePagination(result.data.pagination);
                    updateUsersCount(result.data.pagination.total);
                } else {
                    adminPanel.showNotification('Erro ao carregar usuários', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                adminPanel.showNotification('Erro de conexão', 'error');
            } finally {
                adminPanel.showLoading(false);
            }
        }
        
        function displayUsers(users) {
            const usersList = document.getElementById('users-list');
            
            if (users.length === 0) {
                usersList.innerHTML = '<div class="text-center py-5"><i class="fas fa-users fa-3x text-muted mb-3"></i><p class="text-muted">Nenhum usuário encontrado</p></div>';
                return;
            }
            
            if (viewMode === 'list') {
                displayUsersList(users);
            } else {
                displayUsersGrid(users);
            }
        }
        
        function displayUsersList(users) {
            const usersList = document.getElementById('users-list');
            
            const table = `
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="50">
                                <input type="checkbox" class="form-check-input" onchange="toggleAllUsers(this)">
                            </th>
                            <th>Usuário</th>
                            <th>Email</th>
                            <th width="100">Tipo</th>
                            <th width="100">Status</th>
                            <th width="120">Cadastro</th>
                            <th width="120">Último Acesso</th>
                            <th width="120">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>
                                    <input type="checkbox" class="form-check-input user-checkbox" value="${user.id}">
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="${user.foto || '../assets/images/default-avatar.svg'}" alt="${user.nome}" class="rounded-circle me-3" width="40" height="40">
                                        <div>
                                            <div class="fw-medium">${user.nome}</div>
                                            <small class="text-muted">ID: ${user.id}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div>${user.email}</div>
                                    ${user.email_verificado ? '<small class="text-success"><i class="fas fa-check-circle"></i> Verificado</small>' : '<small class="text-warning"><i class="fas fa-exclamation-circle"></i> Não verificado</small>'}
                                </td>
                                <td>
                                    <span class="badge ${getUserTypeBadge(user.tipo)}">
                                        ${getUserTypeText(user.tipo)}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge ${getUserStatusBadge(user.status)}">
                                        ${getUserStatusText(user.status)}
                                    </span>
                                </td>
                                <td>
                                    <small>${new Date(user.data_cadastro).toLocaleDateString('pt-BR')}</small>
                                </td>
                                <td>
                                    <small>${user.ultimo_acesso ? new Date(user.ultimo_acesso).toLocaleDateString('pt-BR') : 'Nunca'}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-info" onclick="viewUser(${user.id})" title="Visualizar">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="editUser(${user.id})" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteUser(${user.id})" title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            usersList.innerHTML = table;
        }
        
        function displayUsersGrid(users) {
            const usersList = document.getElementById('users-list');
            
            const grid = `
                <div class="row g-3 p-3">
                    ${users.map(user => `
                        <div class="col-md-6 col-lg-4 col-xl-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <div class="position-relative mb-3">
                                        <input type="checkbox" class="form-check-input position-absolute top-0 start-0 user-checkbox" value="${user.id}">
                                        <img src="${user.foto || '../assets/images/default-avatar.svg'}" alt="${user.nome}" class="rounded-circle mb-2" width="80" height="80">
                                    </div>
                                    <h6 class="card-title">${user.nome}</h6>
                                    <p class="card-text text-muted small">${user.email}</p>
                                    <div class="mb-2">
                                        <span class="badge ${getUserTypeBadge(user.tipo)} me-1">
                                            ${getUserTypeText(user.tipo)}
                                        </span>
                                        <span class="badge ${getUserStatusBadge(user.status)}">
                                            ${getUserStatusText(user.status)}
                                        </span>
                                    </div>
                                    <small class="text-muted d-block">Cadastro: ${new Date(user.data_cadastro).toLocaleDateString('pt-BR')}</small>
                                </div>
                                <div class="card-footer bg-transparent">
                                    <div class="btn-group btn-group-sm w-100">
                                        <button class="btn btn-outline-info" onclick="viewUser(${user.id})" title="Visualizar">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="editUser(${user.id})" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteUser(${user.id})" title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            usersList.innerHTML = grid;
        }
        
        function setupEventListeners() {
            // Search input
            const searchInput = document.getElementById('search-users');
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchUsers();
                }
            });
            
            // User form
            document.getElementById('userForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitUser();
            });
            
            // Avatar upload preview
            document.getElementById('user-avatar').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('avatar-img').src = e.target.result;
                        document.getElementById('avatar-preview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        function showUserModal(userId = null) {
            currentUserId = userId;
            const modal = document.getElementById('userModal');
            const title = document.getElementById('userModalTitle');
            const form = document.getElementById('userForm');
            
            form.reset();
            document.getElementById('avatar-preview').style.display = 'none';
            
            if (userId) {
                title.textContent = 'Editar Usuário';
                loadUserData(userId);
            } else {
                title.textContent = 'Novo Usuário';
                document.getElementById('user-id').value = '';
            }
            
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
        }
        
        async function loadUserData(userId) {
            try {
                const result = await adminPanel.apiGet(`admin/usuarios/${userId}`);
                
                if (result.success) {
                    const user = result.data;
                    
                    document.getElementById('user-id').value = user.id;
                    document.getElementById('user-name').value = user.nome;
                    document.getElementById('user-email').value = user.email;
                    document.getElementById('user-type').value = user.tipo;
                    document.getElementById('user-status').value = user.status;
                    document.getElementById('user-bio').value = user.biografia || '';
                    document.getElementById('user-phone').value = user.telefone || '';
                    document.getElementById('user-birthdate').value = user.data_nascimento || '';
                    document.getElementById('user-newsletter').checked = user.newsletter_inscrito;
                    document.getElementById('user-verified').checked = user.email_verificado;
                    
                    if (user.foto) {
                        document.getElementById('avatar-img').src = user.foto;
                        document.getElementById('avatar-preview').style.display = 'block';
                    }
                } else {
                    adminPanel.showNotification('Erro ao carregar dados do usuário', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar usuário:', error);
                adminPanel.showNotification('Erro de conexão', 'error');
            }
        }
        
        async function submitUser() {
            const formData = new FormData();
            
            const userId = document.getElementById('user-id').value;
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const password = document.getElementById('user-password').value;
            const passwordConfirm = document.getElementById('user-password-confirm').value;
            const type = document.getElementById('user-type').value;
            const status = document.getElementById('user-status').value;
            const bio = document.getElementById('user-bio').value.trim();
            const phone = document.getElementById('user-phone').value.trim();
            const birthdate = document.getElementById('user-birthdate').value;
            const newsletter = document.getElementById('user-newsletter').checked;
            const verified = document.getElementById('user-verified').checked;
            const avatarFile = document.getElementById('user-avatar').files[0];
            
            if (!name || !email) {
                adminPanel.showNotification('Preencha todos os campos obrigatórios', 'warning');
                return;
            }
            
            if (password && password !== passwordConfirm) {
                adminPanel.showNotification('As senhas não coincidem', 'warning');
                return;
            }
            
            // Add form data
            if (userId) formData.append('id', userId);
            formData.append('nome', name);
            formData.append('email', email);
            if (password) formData.append('senha', password);
            formData.append('tipo', type);
            formData.append('status', status);
            formData.append('biografia', bio);
            formData.append('telefone', phone);
            formData.append('data_nascimento', birthdate);
            formData.append('newsletter_inscrito', newsletter);
            formData.append('email_verificado', verified);
            if (avatarFile) formData.append('foto', avatarFile);
            
            try {
                const url = userId ? `admin/usuarios/${userId}` : 'admin/usuarios';
                const method = userId ? 'PUT' : 'POST';
                
                const result = await adminPanel.apiRequest(method, url, formData);
                
                if (result.success) {
                    adminPanel.showNotification(userId ? 'Usuário atualizado com sucesso!' : 'Usuário criado com sucesso!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                    loadUsers();
                    loadStats();
                } else {
                    adminPanel.showNotification(result.message || 'Erro ao salvar usuário', 'error');
                }
            } catch (error) {
                console.error('Erro ao salvar usuário:', error);
                adminPanel.showNotification('Erro de conexão', 'error');
            }
        }
        
        async function viewUser(userId) {
            try {
                const result = await adminPanel.apiGet(`admin/usuarios/${userId}`);
                
                if (result.success) {
                    const user = result.data;
                    
                    const content = `
                        <div class="row">
                            <div class="col-md-4 text-center">
                                <img src="${user.foto || '../assets/images/default-avatar.svg'}" alt="${user.nome}" class="rounded-circle mb-3" width="120" height="120">
                                <h5>${user.nome}</h5>
                                <p class="text-muted">${user.email}</p>
                                <div class="mb-2">
                                    <span class="badge ${getUserTypeBadge(user.tipo)} me-1">
                                        ${getUserTypeText(user.tipo)}
                                    </span>
                                    <span class="badge ${getUserStatusBadge(user.status)}">
                                        ${getUserStatusText(user.status)}
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <h6>Informações Pessoais</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>ID:</strong></td><td>${user.id}</td></tr>
                                    <tr><td><strong>Nome:</strong></td><td>${user.nome}</td></tr>
                                    <tr><td><strong>Email:</strong></td><td>${user.email}</td></tr>
                                    <tr><td><strong>Telefone:</strong></td><td>${user.telefone || 'N/A'}</td></tr>
                                    <tr><td><strong>Data de Nascimento:</strong></td><td>${user.data_nascimento ? new Date(user.data_nascimento).toLocaleDateString('pt-BR') : 'N/A'}</td></tr>
                                    <tr><td><strong>Biografia:</strong></td><td>${user.biografia || 'N/A'}</td></tr>
                                </table>
                                
                                <h6 class="mt-4">Informações da Conta</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>Tipo:</strong></td><td>${getUserTypeText(user.tipo)}</td></tr>
                                    <tr><td><strong>Status:</strong></td><td>${getUserStatusText(user.status)}</td></tr>
                                    <tr><td><strong>Email Verificado:</strong></td><td>${user.email_verificado ? 'Sim' : 'Não'}</td></tr>
                                    <tr><td><strong>Newsletter:</strong></td><td>${user.newsletter_inscrito ? 'Inscrito' : 'Não inscrito'}</td></tr>
                                    <tr><td><strong>Data de Cadastro:</strong></td><td>${new Date(user.data_cadastro).toLocaleString('pt-BR')}</td></tr>
                                    <tr><td><strong>Último Acesso:</strong></td><td>${user.ultimo_acesso ? new Date(user.ultimo_acesso).toLocaleString('pt-BR') : 'Nunca'}</td></tr>
                                </table>
                                
                                <h6 class="mt-4">Estatísticas</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>Comentários:</strong></td><td>${user.total_comentarios || 0}</td></tr>
                                    <tr><td><strong>Curtidas:</strong></td><td>${user.total_curtidas || 0}</td></tr>
                                    <tr><td><strong>Notícias (se autor):</strong></td><td>${user.total_noticias || 0}</td></tr>
                                </table>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('user-details-content').innerHTML = content;
                    currentUserId = userId;
                    
                    const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
                    modal.show();
                } else {
                    adminPanel.showNotification('Erro ao carregar dados do usuário', 'error');
                }
            } catch (error) {
                console.error('Erro ao visualizar usuário:', error);
                adminPanel.showNotification('Erro de conexão', 'error');
            }
        }
        
        function editUserFromDetails() {
            bootstrap.Modal.getInstance(document.getElementById('userDetailsModal')).hide();
            showUserModal(currentUserId);
        }
        
        async function deleteUser(userId) {
            if (!confirm('Tem certeza que deseja excluir este usuário? Esta ação não pode ser desfeita.')) {
                return;
            }
            
            try {
                const result = await adminPanel.apiDelete(`admin/usuarios/${userId}`);
                
                if (result.success) {
                    adminPanel.showNotification('Usuário excluído com sucesso!', 'success');
                    loadUsers();
                    loadStats();
                } else {
                    adminPanel.showNotification(result.message || 'Erro ao excluir usuário', 'error');
                }
            } catch (error) {
                console.error('Erro ao excluir usuário:', error);
                adminPanel.showNotification('Erro de conexão', 'error');
            }
        }
        
        // Utility functions
        function getUserTypeBadge(type) {
            const badges = {
                'admin': 'bg-danger',
                'autor': 'bg-warning',
                'usuario': 'bg-info'
            };
            return badges[type] || 'bg-secondary';
        }
        
        function getUserTypeText(type) {
            const texts = {
                'admin': 'Administrador',
                'autor': 'Autor',
                'usuario': 'Usuário'
            };
            return texts[type] || type;
        }
        
        function getUserStatusBadge(status) {
            const badges = {
                'ativo': 'bg-success',
                'inativo': 'bg-secondary',
                'suspenso': 'bg-warning',
                'pendente': 'bg-info'
            };
            return badges[status] || 'bg-secondary';
        }
        
        function getUserStatusText(status) {
            const texts = {
                'ativo': 'Ativo',
                'inativo': 'Inativo',
                'suspenso': 'Suspenso',
                'pendente': 'Pendente'
            };
            return texts[status] || status;
        }
        
        function setViewMode(mode) {
            viewMode = mode;
            loadUsers();
        }
        
        function updatePagination(pagination) {
            // Implementation similar to other pages
        }
        
        function updateUsersCount(total) {
            const usersCount = document.getElementById('users-count');
            usersCount.textContent = `${total} usuário${total !== 1 ? 's' : ''} encontrado${total !== 1 ? 's' : ''}`;
        }
        
        function toggleAllUsers(checkbox) {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }
        
        function searchUsers() {
            const searchTerm = document.getElementById('search-users').value.trim();
            currentFilters.search = searchTerm;
            currentPage = 1;
            loadUsers();
        }
        
        function filterUsers() {
            const status = document.getElementById('status-filter').value;
            const type = document.getElementById('type-filter').value;
            const period = document.getElementById('period-filter').value;
            
            currentFilters = {};
            if (status) currentFilters.status = status;
            if (type) currentFilters.tipo = type;
            if (period) currentFilters.periodo = period;
            
            currentPage = 1;
            loadUsers();
        }
        
        function clearFilters() {
            document.getElementById('search-users').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('type-filter').value = '';
            document.getElementById('period-filter').value = '';
            
            currentFilters = {};
            currentPage = 1;
            loadUsers();
        }
        
        function sortUsers() {
            currentSort = document.getElementById('sort-users').value;
            currentPage = 1;
            loadUsers();
        }
        
        function changePerPage() {
            perPage = parseInt(document.getElementById('per-page').value);
            currentPage = 1;
            loadUsers();
        }
        
        // Placeholder functions for bulk actions
        function showBulkActions() {
            alert('Funcionalidade de ações em lote será implementada');
        }
        
        function bulkActivate() {
            alert('Funcionalidade de ativação em lote será implementada');
        }
        
        function bulkSuspend() {
            alert('Funcionalidade de suspensão em lote será implementada');
        }
        
        function bulkDelete() {
            alert('Funcionalidade de exclusão em lote será implementada');
        }
        
        function exportUsers() {
            alert('Funcionalidade de exportação será implementada');
        }
        
        // Logout function
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.removeItem('admin_token');
                localStorage.removeItem('admin_user');
                window.location.href = '../login.html';
            }
        }
        
        // Initialize admin panel
        const adminPanel = new AdminPanel();
    </script>
</body>
</html>