<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Login e Preferências</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        .checkbox-group { margin: 10px 0; }
        .checkbox-group input { margin-right: 10px; }
    </style>
</head>
<body>
    <h1>Teste Completo: Login e Carregamento de Preferências</h1>
    
    <div class="section">
        <h2>1. Fazer Login Automático</h2>
        <button onclick="doLogin()">Fazer Login</button>
        <div id="login-result"></div>
    </div>
    
    <div class="section">
        <h2>2. Carregar Dados do Perfil</h2>
        <button onclick="loadProfile()">Carregar Perfil</button>
        <div id="profile-result"></div>
    </div>
    
    <div class="section">
        <h2>3. Testar Checkboxes de Categorias</h2>
        <div class="checkbox-group">
            <label><input type="checkbox" name="favorite_categories[]" value="1"> Política</label><br>
            <label><input type="checkbox" name="favorite_categories[]" value="2"> Economia</label><br>
            <label><input type="checkbox" name="favorite_categories[]" value="3"> Esportes</label><br>
            <label><input type="checkbox" name="favorite_categories[]" value="4"> Tecnologia</label><br>
            <label><input type="checkbox" name="favorite_categories[]" value="5"> Saúde</label><br>
            <label><input type="checkbox" name="favorite_categories[]" value="6"> Entretenimento</label><br>
            <label><input type="checkbox" name="favorite_categories[]" value="7"> Mundo</label><br>
        </div>
        <select id="language-preference">
            <option value="pt-BR">Português (Brasil)</option>
            <option value="en-US">English (US)</option>
            <option value="es-ES">Español</option>
        </select>
        <button onclick="testPreferencesPopulation()">Popular Preferências</button>
        <div id="preferences-result"></div>
    </div>

    <script>
        let currentToken = null;
        let profileData = null;
        
        async function doLogin() {
            const resultDiv = document.getElementById('login-result');
            resultDiv.innerHTML = '<p>Fazendo login...</p>';
            
            try {
                const response = await fetch('http://localhost:8001/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'ronaldguilhon@gmail.com',
                        senha: 'Rede@@123'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        currentToken = result.token;
                        
                        // Salvar no localStorage como o sistema real faz
                        localStorage.setItem('authToken', currentToken);
                        localStorage.setItem('portal-user', JSON.stringify({
                            token: currentToken,
                            user: result.usuario
                        }));
                        
                        resultDiv.innerHTML = `
                            <p class="success">✅ Login realizado com sucesso!</p>
                            <p>Token: ${currentToken.substring(0, 50)}...</p>
                            <p>Usuário: ${result.usuario.nome}</p>
                        `;
                    } else {
                        resultDiv.innerHTML = `<p class="error">❌ Erro no login: ${result.mensagem}</p>`;
                    }
                } else {
                    resultDiv.innerHTML = `<p class="error">❌ Erro HTTP: ${response.status}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">❌ Erro na requisição: ${error.message}</p>`;
            }
        }
        
        async function loadProfile() {
            const resultDiv = document.getElementById('profile-result');
            
            if (!currentToken) {
                resultDiv.innerHTML = '<p class="error">❌ Faça login primeiro!</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p>Carregando perfil...</p>';
            
            try {
                const response = await fetch('http://localhost:8001/api/user/profile', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        profileData = result.data;
                        
                        resultDiv.innerHTML = `
                            <p class="success">✅ Perfil carregado com sucesso!</p>
                            <pre>${JSON.stringify(result.data, null, 2)}</pre>
                        `;
                    } else {
                        resultDiv.innerHTML = `<p class="error">❌ Erro: ${result.mensagem}</p>`;
                    }
                } else {
                    resultDiv.innerHTML = `<p class="error">❌ Erro HTTP: ${response.status}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">❌ Erro na requisição: ${error.message}</p>`;
            }
        }
        
        function testPreferencesPopulation() {
            const resultDiv = document.getElementById('preferences-result');
            
            if (!profileData) {
                resultDiv.innerHTML = '<p class="error">❌ Carregue o perfil primeiro!</p>';
                return;
            }
            
            let log = [];
            
            // Testar categorias favoritas
            log.push('=== TESTANDO CATEGORIAS FAVORITAS ===');
            log.push(`Dados recebidos: ${JSON.stringify(profileData.favorite_categories)}`);
            
            if (profileData.favorite_categories) {
                const favoriteCategories = Array.isArray(profileData.favorite_categories) ? 
                    profileData.favorite_categories : 
                    JSON.parse(profileData.favorite_categories || '[]');
                    
                log.push(`Categorias processadas: ${JSON.stringify(favoriteCategories)}`);
                
                const checkboxes = document.querySelectorAll('input[name="favorite_categories[]"]');
                log.push(`Checkboxes encontrados: ${checkboxes.length}`);
                
                let markedCount = 0;
                checkboxes.forEach(checkbox => {
                    const isChecked = favoriteCategories.includes(parseInt(checkbox.value));
                    checkbox.checked = isChecked;
                    if (isChecked) markedCount++;
                    log.push(`Checkbox ${checkbox.value}: ${isChecked ? 'MARCADO' : 'DESMARCADO'}`);
                });
                
                log.push(`Total de checkboxes marcados: ${markedCount}`);
            }
            
            // Testar preferência de idioma
            log.push('\n=== TESTANDO PREFERÊNCIA DE IDIOMA ===');
            log.push(`Idioma recebido: ${profileData.language_preference}`);
            
            const languageSelect = document.getElementById('language-preference');
            if (languageSelect && profileData.language_preference) {
                languageSelect.value = profileData.language_preference;
                log.push(`Idioma definido para: ${profileData.language_preference}`);
                log.push(`Valor atual do select: ${languageSelect.value}`);
            }
            
            resultDiv.innerHTML = `
                <p class="success">✅ Teste de população concluído!</p>
                <pre>${log.join('\n')}</pre>
            `;
        }
    </script>
</body>
</html>