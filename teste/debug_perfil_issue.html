<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Problema do Perfil Admin</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        .warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .profile-data {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .profile-image {
            max-width: 150px;
            max-height: 150px;
            border-radius: 50%;
            margin: 10px 0;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .comparison-item {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .field-check {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .field-check:last-child {
            border-bottom: none;
        }
        .status-icon {
            font-weight: bold;
        }
        .ok { color: green; }
        .missing { color: red; }
        .empty { color: orange; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug - Problema do Perfil Admin</h1>
        <p>Este teste identifica exatamente onde est√° o problema com os dados do usu√°rio admin@portal.com</p>
        
        <div class="step info">
            <h3>üìã Status do Diagn√≥stico</h3>
            <div id="diagnosticStatus">Aguardando in√≠cio do diagn√≥stico...</div>
        </div>
    </div>
    
    <div class="container">
        <h2>üîß Testes Automatizados</h2>
        
        <div class="step">
            <h3>1Ô∏è‚É£ Verificar Estado do LocalStorage</h3>
            <button onclick="checkLocalStorage()">Verificar LocalStorage</button>
            <div id="localStorageResult"></div>
        </div>
        
        <div class="step">
            <h3>2Ô∏è‚É£ Fazer Login e Verificar Token</h3>
            <button onclick="performLogin()">Login admin@portal.com</button>
            <div id="loginResult"></div>
        </div>
        
        <div class="step">
            <h3>3Ô∏è‚É£ Testar API de Perfil</h3>
            <button onclick="testProfileAPI()">Testar API /api/user/profile</button>
            <div id="apiResult"></div>
        </div>
        
        <div class="step">
            <h3>4Ô∏è‚É£ Simular Fun√ß√£o populateUserData</h3>
            <button onclick="simulatePopulateUserData()">Simular Preenchimento dos Dados</button>
            <div id="populateResult"></div>
        </div>
        
        <div class="step">
            <h3>5Ô∏è‚É£ Verificar Elementos HTML</h3>
            <button onclick="checkHTMLElements()">Verificar Elementos da P√°gina</button>
            <div id="elementsResult"></div>
        </div>
        
        <div class="step">
            <h3>üîÑ Diagn√≥stico Completo</h3>
            <button onclick="runFullDiagnostic()">Executar Diagn√≥stico Completo</button>
            <div id="fullDiagnosticResult"></div>
        </div>
    </div>
    
    <!-- Elementos simulados da p√°gina de perfil -->
    <div class="container">
        <h2>üé≠ Simula√ß√£o da P√°gina de Perfil</h2>
        <div class="profile-data">
            <h4>Elementos que deveriam ser preenchidos:</h4>
            <div class="comparison">
                <div class="comparison-item">
                    <h5>üìä Informa√ß√µes B√°sicas</h5>
                    <div class="field-check">
                        <span>Nome do Perfil:</span>
                        <span id="profile-name">Nome do Usu√°rio</span>
                        <span class="status-icon missing" id="profile-name-status">‚ùå</span>
                    </div>
                    <div class="field-check">
                        <span>Email do Perfil:</span>
                        <span id="profile-email">usuario@email.com</span>
                        <span class="status-icon missing" id="profile-email-status">‚ùå</span>
                    </div>
                    <div class="field-check">
                        <span>Nome do Usu√°rio:</span>
                        <span id="user-name">Usu√°rio</span>
                        <span class="status-icon missing" id="user-name-status">‚ùå</span>
                    </div>
                    <div class="field-check">
                        <span>Avatar:</span>
                        <img id="profile-avatar" src="assets/images/default-avatar.svg" alt="Avatar" style="width: 50px; height: 50px; border-radius: 50%;">
                        <span class="status-icon missing" id="profile-avatar-status">‚ùå</span>
                    </div>
                </div>
                
                <div class="comparison-item">
                    <h5>üìù Campos de Formul√°rio</h5>
                    <div class="field-check">
                        <span>Nome:</span>
                        <input type="text" id="edit-name" value="" readonly style="width: 150px;">
                        <span class="status-icon missing" id="edit-name-status">‚ùå</span>
                    </div>
                    <div class="field-check">
                        <span>Email:</span>
                        <input type="email" id="edit-email" value="" readonly style="width: 150px;">
                        <span class="status-icon missing" id="edit-email-status">‚ùå</span>
                    </div>
                    <div class="field-check">
                        <span>Telefone:</span>
                        <input type="text" id="edit-phone" value="" readonly style="width: 150px;">
                        <span class="status-icon missing" id="edit-phone-status">‚ùå</span>
                    </div>
                    <div class="field-check">
                        <span>Bio:</span>
                        <textarea id="edit-bio" readonly style="width: 150px; height: 60px;"></textarea>
                        <span class="status-icon missing" id="edit-bio-status">‚ùå</span>
                    </div>
                    <div class="field-check">
                        <span>Cidade:</span>
                        <input type="text" id="edit-city" value="" readonly style="width: 150px;">
                        <span class="status-icon missing" id="edit-city-status">‚ùå</span>
                    </div>
                    <div class="field-check">
                        <span>Estado:</span>
                        <input type="text" id="edit-state" value="" readonly style="width: 150px;">
                        <span class="status-icon missing" id="edit-state-status">‚ùå</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';
        let currentToken = null;
        let profileData = null;
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        }
        
        function updateStatus(message) {
            document.getElementById('diagnosticStatus').innerHTML = `<strong>${message}</strong>`;
        }
        
        function checkLocalStorage() {
            log('localStorageResult', 'üîç Verificando LocalStorage...', 'info');
            
            const portalUser = localStorage.getItem('portal-user');
            const authToken = localStorage.getItem('authToken');
            const userData = localStorage.getItem('userData');
            
            if (portalUser) {
                try {
                    const parsed = JSON.parse(portalUser);
                    log('localStorageResult', `‚úÖ portal-user encontrado: ${JSON.stringify(parsed, null, 2)}`, 'success');
                    if (parsed.token) {
                        currentToken = parsed.token;
                        log('localStorageResult', `üîë Token extra√≠do: ${currentToken.substring(0, 50)}...`, 'success');
                    }
                } catch (e) {
                    log('localStorageResult', `‚ùå Erro ao parsear portal-user: ${e.message}`, 'error');
                }
            } else {
                log('localStorageResult', '‚ùå portal-user n√£o encontrado', 'error');
            }
            
            if (authToken) {
                log('localStorageResult', `‚úÖ authToken encontrado: ${authToken.substring(0, 50)}...`, 'success');
                if (!currentToken) currentToken = authToken;
            } else {
                log('localStorageResult', '‚ùå authToken n√£o encontrado', 'error');
            }
            
            if (userData) {
                log('localStorageResult', `‚úÖ userData encontrado: ${userData}`, 'success');
            } else {
                log('localStorageResult', '‚ùå userData n√£o encontrado', 'error');
            }
        }
        
        async function performLogin() {
            log('loginResult', 'üîê Iniciando login...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@portal.com',
                        senha: 'Rede@@123'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.sucesso) {
                    currentToken = data.token;
                    localStorage.setItem('portal-user', JSON.stringify({
                        token: data.token,
                        user: data.dados
                    }));
                    
                    log('loginResult', '‚úÖ Login realizado com sucesso!', 'success');
                    log('loginResult', `üîë Token: ${data.token.substring(0, 50)}...`, 'success');
                    log('loginResult', `üë§ Dados do usu√°rio: ${JSON.stringify(data.dados, null, 2)}`, 'success');
                } else {
                    log('loginResult', `‚ùå Erro no login: ${data.mensagem || 'Erro desconhecido'}`, 'error');
                }
            } catch (error) {
                log('loginResult', `‚ùå Erro na requisi√ß√£o de login: ${error.message}`, 'error');
            }
        }
        
        async function testProfileAPI() {
            log('apiResult', 'üì° Testando API de perfil...', 'info');
            
            if (!currentToken) {
                log('apiResult', '‚ùå Token n√£o encontrado. Fa√ßa login primeiro.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/api/user/profile`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    profileData = data.data;
                    log('apiResult', '‚úÖ API de perfil funcionando!', 'success');
                    log('apiResult', `üìä Dados recebidos: ${JSON.stringify(data.data, null, 2)}`, 'success');
                    
                    // Verificar campos espec√≠ficos
                    const fields = ['id', 'nome', 'email', 'bio', 'foto_perfil', 'telefone', 'cidade', 'estado'];
                    fields.forEach(field => {
                        const value = data.data[field];
                        const status = value ? '‚úÖ' : '‚ùå';
                        const displayValue = value || 'VAZIO/NULL';
                        log('apiResult', `${status} ${field}: ${displayValue}`, value ? 'success' : 'warning');
                    });
                } else {
                    log('apiResult', `‚ùå Erro na API: ${data.mensagem || 'Erro desconhecido'}`, 'error');
                    log('apiResult', `üìã Resposta completa: ${JSON.stringify(data, null, 2)}`, 'error');
                }
            } catch (error) {
                log('apiResult', `‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
            }
        }
        
        function simulatePopulateUserData() {
            log('populateResult', 'üé≠ Simulando populateUserData...', 'info');
            
            if (!profileData) {
                log('populateResult', '‚ùå Dados do perfil n√£o dispon√≠veis. Execute o teste da API primeiro.', 'error');
                return;
            }
            
            log('populateResult', 'üìù Preenchendo elementos da p√°gina...', 'info');
            
            // Simular a fun√ß√£o populateUserData
            const userData = profileData;
            
            // Update profile info
            const profileName = document.getElementById('profile-name');
            const profileEmail = document.getElementById('profile-email');
            const userName = document.getElementById('user-name');
            
            if (profileName) {
                profileName.textContent = userData.nome || 'Nome do Usu√°rio';
                updateFieldStatus('profile-name-status', userData.nome);
                log('populateResult', `‚úÖ profile-name atualizado: ${userData.nome}`, 'success');
            }
            
            if (profileEmail) {
                profileEmail.textContent = userData.email || 'usuario@email.com';
                updateFieldStatus('profile-email-status', userData.email);
                log('populateResult', `‚úÖ profile-email atualizado: ${userData.email}`, 'success');
            }
            
            if (userName) {
                userName.textContent = userData.nome || 'Usu√°rio';
                updateFieldStatus('user-name-status', userData.nome);
                log('populateResult', `‚úÖ user-name atualizado: ${userData.nome}`, 'success');
            }
            
            // Update form fields
            const formFields = [
                { id: 'edit-name', value: userData.nome },
                { id: 'edit-email', value: userData.email },
                { id: 'edit-phone', value: userData.telefone },
                { id: 'edit-bio', value: userData.bio },
                { id: 'edit-city', value: userData.cidade },
                { id: 'edit-state', value: userData.estado }
            ];
            
            formFields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    element.value = field.value || '';
                    updateFieldStatus(`${field.id}-status`, field.value);
                    log('populateResult', `‚úÖ ${field.id} atualizado: ${field.value || 'VAZIO'}`, field.value ? 'success' : 'warning');
                }
            });
            
            // Update avatar
            const avatarElement = document.getElementById('profile-avatar');
            if (avatarElement) {
                if (userData.foto_perfil) {
                    avatarElement.src = userData.foto_perfil;
                    updateFieldStatus('profile-avatar-status', userData.foto_perfil);
                    log('populateResult', `‚úÖ Avatar atualizado: ${userData.foto_perfil}`, 'success');
                } else {
                    avatarElement.src = 'assets/images/default-avatar.svg';
                    updateFieldStatus('profile-avatar-status', null);
                    log('populateResult', `‚ö†Ô∏è Avatar padr√£o usado (foto_perfil vazia)`, 'warning');
                }
            }
            
            log('populateResult', '‚úÖ Simula√ß√£o de populateUserData conclu√≠da!', 'success');
        }
        
        function updateFieldStatus(statusId, value) {
            const statusElement = document.getElementById(statusId);
            if (statusElement) {
                if (value) {
                    statusElement.textContent = '‚úÖ';
                    statusElement.className = 'status-icon ok';
                } else {
                    statusElement.textContent = '‚ùå';
                    statusElement.className = 'status-icon empty';
                }
            }
        }
        
        function checkHTMLElements() {
            log('elementsResult', 'üîç Verificando elementos HTML...', 'info');
            
            const requiredElements = [
                'profile-name', 'profile-email', 'user-name', 'profile-avatar',
                'edit-name', 'edit-email', 'edit-phone', 'edit-bio', 'edit-city', 'edit-state'
            ];
            
            let allElementsFound = true;
            
            requiredElements.forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    log('elementsResult', `‚úÖ Elemento '${elementId}' encontrado`, 'success');
                } else {
                    log('elementsResult', `‚ùå Elemento '${elementId}' N√ÉO encontrado`, 'error');
                    allElementsFound = false;
                }
            });
            
            if (allElementsFound) {
                log('elementsResult', '‚úÖ Todos os elementos HTML necess√°rios foram encontrados!', 'success');
            } else {
                log('elementsResult', '‚ùå Alguns elementos HTML est√£o faltando na p√°gina real!', 'error');
            }
        }
        
        async function runFullDiagnostic() {
            updateStatus('Executando diagn√≥stico completo...');
            document.getElementById('fullDiagnosticResult').innerHTML = '';
            
            log('fullDiagnosticResult', 'üöÄ Iniciando diagn√≥stico completo...', 'info');
            
            // 1. Limpar localStorage
            localStorage.clear();
            log('fullDiagnosticResult', 'üßπ LocalStorage limpo', 'info');
            
            // 2. Verificar localStorage
            await new Promise(resolve => setTimeout(resolve, 500));
            checkLocalStorage();
            
            // 3. Fazer login
            await new Promise(resolve => setTimeout(resolve, 1000));
            await performLogin();
            
            // 4. Testar API
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testProfileAPI();
            
            // 5. Simular preenchimento
            await new Promise(resolve => setTimeout(resolve, 1000));
            simulatePopulateUserData();
            
            // 6. Verificar elementos
            await new Promise(resolve => setTimeout(resolve, 1000));
            checkHTMLElements();
            
            log('fullDiagnosticResult', '‚úÖ Diagn√≥stico completo finalizado!', 'success');
            
            // Conclus√£o
            if (profileData && currentToken) {
                log('fullDiagnosticResult', 'üéØ CONCLUS√ÉO: A API est√° funcionando e retornando dados corretos.', 'success');
                log('fullDiagnosticResult', 'üí° O problema pode estar na p√°gina perfil.html real ou no carregamento dos dados.', 'warning');
                log('fullDiagnosticResult', 'üîß Recomenda√ß√£o: Verificar console do navegador na p√°gina real e comparar com este teste.', 'info');
            } else {
                log('fullDiagnosticResult', '‚ùå PROBLEMA IDENTIFICADO: Login ou API n√£o est√£o funcionando.', 'error');
            }
            
            updateStatus('Diagn√≥stico completo finalizado');
        }
        
        // Inicializar p√°gina
        window.onload = function() {
            updateStatus('P√°gina carregada - Pronto para diagn√≥stico');
            checkLocalStorage();
        };
    </script>
</body>
</html>